pipeline {
  agent any
  environment {
    DOCKER_IMAGE_BUILD = 'shaiksami179/train-schedule'
  }
  stages {
    stage ('Build') {
      steps {
        echo 'Building Automation'
        sh './gradlew build --no-daemon'
        archiveArtifacts artifacts: 'dist/trainSchedule.zip'
      }
    }
    stage ('Docker Build Automation') {
      when {
        branch 'master'
      }
      steps {
        script {
          app = docker.build(DOCKER_BUILD_IMAGE)
          app.inside {
            sh 'echo Hello, World'
          }
        }
      }
    }
    stage ('Docker Push') {
      when {
        branch 'master'
      }
      steps {
        script {
          docker.withRegistry('https://registry.hub.docker.com', 'docker_hub_login') {
            app.push('${env.BUILD_NUMBER}')
            app.push('latest')
          }
        }
      }
    }
    stage ('Deploy to Production') {
      when {
        branch 'master'
      }
      steps {
        input 'Deploy to Production?'
        milestone(1)
        kubernetesDeploy(
          kubeconfigId: 'kubeconfig'
          configs: '<your_yaml_file_here>'
          enableConfigSubstitution: true
        )
      }
    }
  }
}
